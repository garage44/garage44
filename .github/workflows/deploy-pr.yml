name: Deploy PR to VPS

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main

jobs:
  deploy-pr:
    name: Trigger VPS PR Deployment
    runs-on: ubuntu-latest
    # Only run for PRs from the same repository (not forks)
    if: github.event.pull_request.head.repo.full_name == github.repository

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Trigger PR webhook
        env:
          WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
          WEBHOOK_SECRET: ${{ secrets.WEBHOOK_SECRET }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          BRANCH_NAME: ${{ github.event.pull_request.head.ref }}
        run: |
          # Get the webhook payload (compact JSON, no extra whitespace)
          PAYLOAD="{\"ref\":\"refs/heads/${BRANCH_NAME}\",\"pull_request\":{\"number\":${PR_NUMBER}},\"repository\":{\"owner\":{\"login\":\"${{ github.repository_owner }}\"},\"name\":\"${{ github.event.repository.name }}\",\"default_branch\":\"main\"}}"

          # Calculate HMAC SHA-256 signature
          SIGNATURE=$(echo -n "$PAYLOAD" | openssl dgst -sha256 -hmac "$WEBHOOK_SECRET" -binary | xxd -p -c 256)

          # Send webhook request to PR endpoint
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "${WEBHOOK_URL}/pr" \
            -H "Content-Type: application/json" \
            -H "X-GitHub-Event: push" \
            -H "X-Hub-Signature-256: sha256=$SIGNATURE" \
            -d "$PAYLOAD")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)

          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "✅ PR deployment webhook triggered successfully (HTTP $HTTP_CODE)"
            echo "Response: $BODY"
          else
            echo "❌ PR deployment webhook failed (HTTP $HTTP_CODE)"
            echo "Response: $BODY"
            exit 1
          fi
