name: Deploy to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Trigger VPS Deployment
    runs-on: ubuntu-latest

    steps:
      - name: Trigger webhook
        env:
          WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
          WEBHOOK_SECRET: ${{ secrets.WEBHOOK_SECRET }}
        run: |
          # Get the webhook payload (compact JSON, no extra whitespace)
          PAYLOAD='{"ref":"refs/heads/main","repository":{"default_branch":"main"}}'

          # Calculate HMAC SHA-256 signature
          SIGNATURE=$(echo -n "$PAYLOAD" | openssl dgst -sha256 -hmac "$WEBHOOK_SECRET" -binary | xxd -p -c 256)

          # Send webhook request
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -H "X-GitHub-Event: push" \
            -H "X-Hub-Signature-256: sha256=$SIGNATURE" \
            -d "$PAYLOAD")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)

          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "✅ Deployment webhook triggered successfully (HTTP $HTTP_CODE)"
            echo "Response: $BODY"
          else
            echo "❌ Deployment webhook failed (HTTP $HTTP_CODE)"
            echo "Response: $BODY"
            exit 1
          fi
