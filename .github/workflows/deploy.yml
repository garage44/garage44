name: Deploy to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy code
    runs-on: ubuntu-latest

    steps:
      - name: Trigger webhook
        env:
          WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
          WEBHOOK_SECRET: ${{ secrets.WEBHOOK_SECRET }}
        run: |
          # Get the webhook payload (compact JSON, no extra whitespace)
          PAYLOAD='{"ref":"refs/heads/main","repository":{"default_branch":"main"}}'

          # Calculate HMAC SHA-256 signature
          SIGNATURE=$(echo -n "$PAYLOAD" | openssl dgst -sha256 -hmac "$WEBHOOK_SECRET" -binary | xxd -p -c 256)

          # Send webhook request
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -H "X-GitHub-Event: push" \
            -H "X-Hub-Signature-256: sha256=$SIGNATURE" \
            -d "$PAYLOAD")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)

          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "âœ… Deployment webhook triggered successfully (HTTP $HTTP_CODE)"
            echo ""
            echo "Response:"
            echo "$BODY" | jq '.' 2>/dev/null || echo "$BODY"
            echo ""

            # Parse and display deployment status
            SUCCESS=$(echo "$BODY" | jq -r '.success // empty' 2>/dev/null)
            MESSAGE=$(echo "$BODY" | jq -r '.message // empty' 2>/dev/null)
            TIMESTAMP=$(echo "$BODY" | jq -r '.timestamp // empty' 2>/dev/null)

            if [ "$SUCCESS" = "true" ]; then
              echo "âœ… Deployment Status: SUCCESS"
              echo "ðŸ“ Message: $MESSAGE"
              if [ -n "$TIMESTAMP" ]; then
                echo "ðŸ• Timestamp: $TIMESTAMP"
              fi
            elif [ "$SUCCESS" = "false" ]; then
              echo "âŒ Deployment Status: FAILED"
              echo "ðŸ“ Message: $MESSAGE"
              if [ -n "$TIMESTAMP" ]; then
                echo "ðŸ• Timestamp: $TIMESTAMP"
              fi
              exit 1
            fi
          else
            echo "âŒ Deployment webhook failed (HTTP $HTTP_CODE)"
            echo ""
            echo "Response:"
            echo "$BODY" | jq '.' 2>/dev/null || echo "$BODY"
            exit 1
          fi
