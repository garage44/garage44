---
description: "PR deployment testing workflow - guides AI to test newly built features on automatically created PR deployments"
globs:
  - "**/*"
alwaysApply: true
---

# Garage44 PR Deployment Testing Rules

This file contains rules for AI assistants to test newly built features on PR deployments that are automatically created for each PR.

## Overview

PR deployments are **automatically created** when a PR is opened or updated. Each PR gets an isolated, publicly accessible testing environment. Agents should use these deployments to verify features work correctly before marking tasks as complete.

**Key Points:**
- PR deployments are automatically created by GitHub Actions when PRs are opened/updated
- Deployment URL is posted as a comment on the PR by the GitHub Actions bot
- PR deployments are publicly accessible at `https://pr-{number}.garage44.org` (no authentication required)
- Each PR gets an isolated environment with its own ports, database, and directory
- Deployments are automatically cleaned up after 7 days or when PR is closed
- Only contributor PRs are deployed (forks are blocked)

## When to Test on PR Deployment

**Always test on PR deployment when:**
- ‚úÖ Implementing a new feature that requires end-to-end verification
- ‚úÖ Fixing bugs that need live environment testing
- ‚úÖ Making UI changes that need visual verification
- ‚úÖ Testing integrations between multiple packages (expressio, pyrite, malkovich)
- ‚úÖ Verifying WebSocket functionality or real-time features
- ‚úÖ Testing authentication or authorization flows
- ‚úÖ User requests to see changes live

**Optional (but recommended):**
- üîÑ Refactoring that might affect runtime behavior
- üîÑ Performance optimizations that need real-world testing
- üîÑ Database migrations or schema changes

**Skip testing for:**
- ‚ùå Pure documentation changes
- ‚ùå Type-only changes (TypeScript types, no runtime impact)
- ‚ùå Linter/formatting fixes only
- ‚ùå Test-only changes

## Finding the PR Deployment URL

### Method 1: Check PR Comments (Recommended)

GitHub Actions automatically posts the deployment URL as a comment on the PR:

```
üöÄ **PR Deployment Available**

Malkovich: https://pr-123.garage44.org
Expressio: https://pr-123.garage44.org
Pyrite: https://pr-123.garage44.org

_This deployment will be automatically cleaned up when the PR is closed._
```

**Look for:**
- Comments from GitHub Actions bot
- Comments containing "PR Deployment Available"
- URLs matching pattern `https://pr-{number}.garage44.org`

### Method 2: Construct from PR Number

If you know the PR number, construct the URL:

```
https://pr-{PR_NUMBER}.garage44.org
```

**Example:**
- PR #123 ‚Üí `https://pr-123.garage44.org`
- PR #456 ‚Üí `https://pr-456.garage44.org`

### Method 3: Check GitHub Actions

If the deployment comment isn't visible:
1. Go to PR ‚Üí "Checks" tab
2. Find "PR Deployment" workflow run
3. Check workflow output for deployment URL

## Testing Workflow

### 1. Find Deployment URL

After implementing a feature and creating/updating a PR:

```bash
# Check PR comments for deployment URL
# Or construct: https://pr-{PR_NUMBER}.garage44.org
```

**Example:**
- PR #123 ‚Üí Deployment URL: `https://pr-123.garage44.org`

### 2. Verify Deployment is Ready

Before testing, verify the deployment is accessible:

```bash
# Check HTTP response
curl -I https://pr-123.garage44.org

# Expected: HTTP 200 or 302 (redirect)
```

**If deployment isn't ready:**
- Wait a few minutes for GitHub Actions to complete
- Check GitHub Actions workflow status
- Verify PR is from a contributor (not a fork)

### 3. Test the Feature

Access the deployment URL and test the newly built feature:

- **UI Features**: Navigate to relevant pages and interact with the UI
- **API Endpoints**: Test API calls using curl or browser dev tools
- **WebSocket**: Verify real-time updates work correctly
- **Authentication**: Test login/logout flows if applicable
- **Cross-package**: Verify all affected packages work together

**Example testing commands:**
```bash
# Test API endpoint
curl https://pr-123.garage44.org/api/workspaces

# Test WebSocket (use browser dev tools)
# Open https://pr-123.garage44.org in browser
# Open browser console and check WebSocket connections

# Visual testing: Open https://pr-123.garage44.org in browser
```

### 4. Report Test Results

After testing, report the results:

```
‚úÖ Feature tested on PR deployment at https://pr-123.garage44.org
- UI changes verified: [describe what was tested]
- API endpoints working: [list endpoints tested]
- WebSocket functionality: [describe real-time features tested]
- No issues found / Issues found: [describe any problems]
```

## Testing Scenarios

### Testing UI Changes

```bash
# 1. Find deployment URL (from PR comment or construct)
# Example: https://pr-123.garage44.org

# 2. Open in browser
# Navigate to https://pr-123.garage44.org

# 3. Test interactions
# - Click buttons, fill forms, navigate pages
# - Check responsive design
# - Verify accessibility (keyboard navigation, screen readers)
# - Test on different screen sizes

# 4. Report
‚úÖ UI changes tested on PR deployment at https://pr-123.garage44.org
- All interactions working correctly
- Responsive design verified
- Accessibility checks passed
```

### Testing API Changes

```bash
# 1. Find deployment URL
# Example: https://pr-123.garage44.org

# 2. Test endpoints
curl https://pr-123.garage44.org/api/workspaces
curl -X POST https://pr-123.garage44.org/api/translations \
  -H "Content-Type: application/json" \
  -d '{"key": "test", "value": "value"}'

# 3. Verify responses
# Check status codes, response bodies, error handling
# Test edge cases (empty data, invalid inputs)

# 4. Report
‚úÖ API changes tested on PR deployment at https://pr-123.garage44.org
- GET /api/workspaces: Working correctly
- POST /api/translations: Working correctly
- Error handling: Verified
```

### Testing WebSocket Features

```bash
# 1. Find deployment URL
# Example: https://pr-123.garage44.org

# 2. Open browser console
# Navigate to https://pr-123.garage44.org
# Open browser dev tools ‚Üí Console ‚Üí Network ‚Üí WS

# 3. Test WebSocket
# - Verify connection established
# - Trigger events that should send WebSocket messages
# - Verify messages received correctly
# - Test reconnection behavior (disconnect network briefly)

# 4. Report
‚úÖ WebSocket features tested on PR deployment at https://pr-123.garage44.org
- Connection established successfully
- Real-time updates working correctly
- Reconnection handling verified
```

### Testing Multi-Package Changes

```bash
# 1. Find deployment URL
# Example: https://pr-123.garage44.org

# 2. Test each package
# - Malkovich: https://pr-123.garage44.org
# - Expressio: https://pr-123.garage44.org (via nginx routing)
# - Pyrite: https://pr-123.garage44.org (via nginx routing)

# 3. Test integration
# - Verify packages communicate correctly
# - Test shared state/WebSocket connections
# - Check cross-package API calls
# - Verify data flows between packages

# 4. Report
‚úÖ Multi-package changes tested on PR deployment at https://pr-123.garage44.org
- All packages accessible and working
- Cross-package communication verified
- Shared state synchronized correctly
```

## Testing Best Practices

### Test Multiple Scenarios

When testing, verify multiple scenarios:

- ‚úÖ **Happy path**: Normal usage flows work correctly
- ‚úÖ **Edge cases**: Empty data, large datasets, boundary conditions
- ‚úÖ **Error handling**: Invalid inputs, network errors, server errors
- ‚úÖ **Cross-browser**: Test on different browsers (if UI changes)
- ‚úÖ **Responsive design**: Test on different screen sizes (if UI changes)

### Test After Each Significant Change

Test on PR deployment after:
- Completing a feature implementation
- Fixing a bug
- Making significant refactoring changes
- Updating dependencies that might affect runtime

### Document Test Results

Always include:
- Deployment URL used for testing
- What was tested (features, endpoints, scenarios)
- Test results (working / issues found)
- Any issues discovered and their status

**Example:**
```
‚úÖ Feature tested on PR deployment

**Deployment**: https://pr-123.garage44.org

**Tested:**
- Batch translation UI: Working correctly
- API endpoint POST /api/translations/batch: Responding as expected
- WebSocket updates: Real-time updates functioning properly
- Error handling: Invalid inputs handled gracefully

**Status**: All tests passed, feature ready for review
```

## Troubleshooting

### Deployment Not Available

**If deployment URL isn't in PR comments:**
1. Check GitHub Actions workflow status (PR ‚Üí Checks tab)
2. Wait a few minutes for deployment to complete
3. Construct URL manually: `https://pr-{PR_NUMBER}.garage44.org`
4. Verify PR is from a contributor (not a fork)

**If deployment URL returns 404 or error:**
1. Check if PR is still open (deployments cleaned up when PR closes)
2. Verify deployment completed successfully in GitHub Actions
3. Check if deployment is older than 7 days (auto-cleanup)

### Feature Not Working on Deployment

**If feature works locally but not on deployment:**
1. Verify latest code is deployed (check GitHub Actions commit SHA)
2. Check browser console for errors
3. Verify environment variables are set correctly (if applicable)
4. Check deployment logs (if accessible)

**If feature behavior differs from local:**
1. Check if database state differs (PR deployments use separate databases)
2. Verify environment configuration matches expectations
3. Check for caching issues (hard refresh browser)

### Can't Access Deployment

**If URL doesn't load:**
1. Verify URL format: `https://pr-{NUMBER}.garage44.org` (not `http://`)
2. Check if deployment is still active (PR not closed, not older than 7 days)
3. Try different browser or incognito mode
4. Check network connectivity

## Security Notes

**What's Protected:**
- ‚úÖ Fork PRs blocked (only contributors get deployments)
- ‚úÖ Rate limited (10 req/s per IP)
- ‚úÖ Not indexed by search engines
- ‚úÖ Resource limited (512MB RAM, 50% CPU per service)
- ‚úÖ Isolated environments (separate directories, databases, ports)

**What's Public:**
- ‚ö†Ô∏è Anyone can view (no authentication required)
- ‚ö†Ô∏è Anyone can interact (full UI access)
- ‚ö†Ô∏è Test data visible (use dummy data only)

**Agent Considerations:**
- Don't include sensitive data or secrets in PRs
- Use test/dummy data for PR deployments
- Verify deployment before sharing URL with users
- Report any security concerns found during testing

## Summary

**For Cursor Agents:**

‚úÖ **Find Deployment**: Check PR comments for deployment URL posted by GitHub Actions bot, or construct `https://pr-{PR_NUMBER}.garage44.org`

‚úÖ **Test**: Access the deployment URL and verify the feature works correctly

‚úÖ **Report**: Include deployment URL and test results in completion message

**Key Workflow:**
1. Implement feature and create/update PR
2. Wait for GitHub Actions to create deployment (automatic)
3. Find deployment URL from PR comments or construct it
4. Test feature on live deployment
5. Report results with deployment URL

**Remember:**
- PR deployments are **automatically created** - no manual deployment needed
- Always test newly built features on PR deployment before marking complete
- Find deployment URL from PR comments (GitHub Actions bot) or construct from PR number
- Test multiple scenarios (happy path, edge cases, errors)
- Report test results with deployment URL and what was tested
