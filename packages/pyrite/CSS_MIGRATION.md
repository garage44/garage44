# CSS Migration - SCSS to Modern CSS

> **See also**: [ADR-011: Modern CSS Migration and Unified Styleguide](../../../docs/adr/ADR-011-modern-css-migration.md) for the architectural decision and rationale behind this migration.

## Overview

Pyrite has been migrated from SCSS to modern CSS with native nesting, following the same pattern as Expressio. The build system uses Bun's native CSS bundler through Bunchy.

This migration is part of a larger initiative to establish a **unified design system** across all Garage44 projects (Pyrite, Expressio) using shared design tokens from the `@garage44/common` package.

## Structure

```
packages/pyrite/
├── src/
│   ├── css/
│   │   ├── app.css          # Main entry point (imported by Bunchy)
│   │   └── _variables.css   # CSS custom properties (design tokens)
│   ├── components/
│   │   └── **/*.css         # Component-scoped styles
│   └── index.html           # Template with build ID placeholders
└── public/
    ├── app.<buildId>.css       # Generated by Bunchy
    ├── components.<buildId>.css # Generated by Bunchy
    └── index.html              # Generated from template
```

## Build Process

### Development Mode
```bash
bun run dev
```

Bunchy automatically:
1. Watches `src/css/app.css` and rebuilds on changes
2. Watches all `src/components/**/*.css` files
3. Generates `public/app.<buildId>.css`
4. Generates `public/components.<buildId>.css`
5. Processes `src/index.html` template to `public/index.html`
6. Hot-reloads the browser on CSS changes

### Production Build
```bash
bun run build
```

Bunchy:
1. Builds all CSS with minification
2. Generates hashed filenames for cache busting
3. Updates index.html with correct asset references

## CSS Architecture

### Design Tokens (_variables.css)

All design tokens are defined as CSS custom properties:

```css
:root {
    /* Spacing scale */
    --spacer-1: 0.5rem;
    --spacer-2: 1rem;
    --spacer-3: 1.5rem;

    /* Color system */
    --info-0: oklch(10% 0.02 240);  /* Darkest */
    --info-9: oklch(98% 0.02 240);  /* Lightest */

    /* Brand colors */
    --brand-primary: oklch(60% 0.15 260);

    /* Font sizes */
    --font-size-base: 1rem;
    --font-size-lg: 1.25rem;
}
```

### Theme System

Light and dark themes use CSS custom properties:

```css
/* Light theme (default) */
:root,
.theme-light {
    --bg-primary: var(--info-9);
    --text-primary: var(--info-1);
}

/* Dark theme */
.theme-dark {
    --bg-primary: var(--info-1);
    --text-primary: var(--info-9);
}
```

The active theme class is applied to the root `<html>` or `<body>` element.

### Modern CSS Features

**Native Nesting:**
```css
.button {
    background: var(--brand-primary);

    &:hover {
        background: var(--brand-secondary);
    }

    &.disabled {
        opacity: 0.5;
    }
}
```

**Container Queries (when needed):**
```css
.component {
    container-type: inline-size;
}

@container (min-width: 400px) {
    .child {
        display: grid;
    }
}
```

## Component Styles

Each component has its own CSS file alongside the component:

```
src/components/
├── conference/
│   ├── app.tsx
│   └── app.css
├── admin/
│   ├── app.tsx
│   └── app.css
└── elements/
    ├── button/
    │   ├── button.tsx
    │   └── button.css
    └── icon/
        ├── icon.tsx
        └── icon.css
```

Component CSS is automatically collected by Bunchy and bundled into `components.<buildId>.css`.

## Migration from SCSS

### Variables
**SCSS:**
```scss
$spacer-1: 0.5rem;
$font-size-base: 1rem;
$primary-color: #194759;
```

**Modern CSS:**
```css
:root {
    --spacer-1: 0.5rem;
    --font-size-base: 1rem;
    --primary-color: oklch(60% 0.15 260);
}
```

### Nesting
**SCSS:**
```scss
.component {
    .child {
        color: blue;
    }

    &:hover {
        opacity: 0.8;
    }
}
```

**Modern CSS:**
```css
.component {
    & .child {
        color: blue;
    }

    &:hover {
        opacity: 0.8;
    }
}
```

### Mixins → CSS Custom Properties
**SCSS:**
```scss
@mixin theme-light {
    background: white;
    color: black;
}

.app {
    @include theme-light;
}
```

**Modern CSS:**
```css
:root {
    --bg: white;
    --text: black;
}

.app {
    background: var(--bg);
    color: var(--text);
}
```

## Color System

### OKLCH Color Space

Pyrite uses OKLCH for predictable perceptual color scaling:

```css
/* Neutral scale from dark to light */
--info-0: oklch(10% 0.02 240);   /* Almost black */
--info-5: oklch(60% 0.02 240);   /* Mid gray */
--info-9: oklch(98% 0.02 240);   /* Almost white */

/* Brand colors with consistent lightness */
--brand-primary: oklch(60% 0.15 260);   /* Blue */
--success: oklch(60% 0.15 140);         /* Green */
--error: oklch(55% 0.18 20);            /* Red */
```

**Why OKLCH?**
- Perceptually uniform (unlike HSL)
- Predictable lightness scaling
- Wide gamut support
- Better for programmatic color generation

## Shared Styles

Common styles from `@garage44/common` package are imported via a **single entry point**:

```css
/* In app.css - ONE import for all common styles */
@import "../../../common/css/theme.css";
```

This single import provides:
- Typography utilities
- Tooltip styles
- Icon fonts
- Form elements
- All future shared common styles

**Why a single import?**
- **Consistency**: All projects automatically receive the same common styles
- **Maintainability**: No need to update imports when common package adds new styles
- **Simplicity**: One line instead of managing multiple import paths
- **Less error-prone**: Can't forget to import a required common file

## Performance

### Bundle Sizes (approximate)

- `app.css`: ~15KB (minified + gzipped)
- `components.css`: ~45KB (minified + gzipped)
- Total CSS: ~60KB

### Optimization

- **Build-time minification** via Bun.build
- **Cache busting** with content hashes
- **No runtime CSS-in-JS overhead**
- **Tree-shaking** unused component styles (manual for now)

## Browser Support

Modern CSS features require:

- **Chrome/Edge**: 109+
- **Firefox**: 117+
- **Safari**: 16.4+

All major browsers from 2023 support CSS nesting natively.

## Development Workflow

1. **Edit CSS**: Make changes to `src/css/app.css` or component CSS files
2. **Auto-rebuild**: Bunchy detects changes and rebuilds
3. **Hot reload**: Browser automatically refreshes with new styles
4. **No preprocessor**: Native CSS means no compilation step needed

## Troubleshooting

### CSS not loading

Check that:
1. `src/css/app.css` exists
2. `src/index.html` references `<%= settings.buildId %>`
3. Bunchy is running in development mode
4. No syntax errors in CSS files

### Variables not working

Ensure:
1. Variables are defined in `:root` or appropriate scope
2. Using `var(--variable-name)` syntax
3. Parent selector defines the variable before child uses it

### Nesting issues

Remember:
1. Use `&` for pseudo-classes: `&:hover`, `&.active`
2. Use `& ` (space) for descendant selectors: `& .child`
3. Top-level selectors don't need `&`

## Future Enhancements

- [ ] CSS layers (`@layer`) for better cascade control
- [ ] Container queries for responsive components
- [ ] CSS `@scope` for component isolation
- [ ] View transitions API for smooth page transitions
- [ ] CSS custom media queries for responsive breakpoints

## Resources

- [MDN: CSS Nesting](https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_nesting)
- [OKLCH Color Picker](https://oklch.com/)
- [Bun Build API](https://bun.sh/docs/bundler)
- [CSS Custom Properties](https://developer.mozilla.org/en-US/docs/Web/CSS/Using_CSS_custom_properties)
